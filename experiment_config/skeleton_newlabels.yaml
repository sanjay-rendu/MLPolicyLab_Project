experiment_name: skeleton2
owner: bills3_group

inputs:
  sql_loc_bill: "/data/groups/bills3/mlpp_project_home/experiment_config/latestLabels.sql"
  sql_bill_text: "/data/groups/bills3/mlpp_project_home/experiment_config/bill_texts.sql"

outputs:
  model_metrics: "/data/groups/bills3/vrenduch/DAGGIT_HOME/daggit_storage/skeleton2/model_metrics.txt"
  model_preds: "/data/groups/bills3/vrenduch/DAGGIT_HOME/daggit_storage/skeleton2/model_preds.csv"
  metrics_base: "/data/groups/bills3/vrenduch/DAGGIT_HOME/daggit_storage/skeleton2/base_metrics.txt"
  metrics_commonsense: "/data/groups/bills3/vrenduch/DAGGIT_HOME/daggit_storage/skeleton2/commonsense_metrics.txt"

graph:
  - node_name: fetch_labeled_data
    inputs: sql_loc_bill
    outputs: bill_data
    operation: data_io.fetch_sql

  - node_name: fetch_bill_text
    inputs: sql_bill_text
    outputs: bill_text
    operation: data_io.fetch_sql

  - node_name: split
    inputs: fetch_labeled_data.bill_data
    outputs: [train, val]
    operation: split.timeSplit
    arguments:
      prediction_date: '2014-01-01'
      validation_end_date: '2015-07-01'

  - node_name: feature_eng
    inputs: [split.train, split.val, fetch_bill_text.bill_text]
    outputs: [train, val]
    operation: feature_eng.topic_model

  - node_name: baseline
    inputs: split.val
    outputs: [baserate, commonsense]
    operation: evaluate.baseline

  - node_name: select
    inputs: [feature_eng.train, feature_eng.val]
    outputs: [fil_train, fil_val]
    operation: data_clean.feature_selector
    arguments:
      selected_features: ['days_to_final', 'days_from_introduction',
                          'number_dems', 'number_republicans', 'is_bipartisan', 'label',
                          'topic_0', 'topic_1', 'topic_2', 'topic_3', 'topic_4', 'topic_5',
                          'topic_6', 'topic_7', 'topic_8', 'topic_9', 'nmf_0', 'nmf_1', 'nmf_2',
                          'nmf_3', 'nmf_4', 'nmf_5', 'nmf_6', 'nmf_7', 'nmf_8', 'nmf_9']

  - node_name: model_logistic_regression
    inputs: select.fil_train
    outputs: model
    operation: model.logistic_regression_trainer
    arguments:
      target: label
      max_iter: 200

  - node_name: validate
    inputs: [select.fil_val, model_logistic_regression.model]
    outputs: val_output
    operation: evaluate.predict_val
    arguments:
      target: label
      threshold: 0.5

  - node_name: topk_model
    inputs: validate.val_output
    outputs: [model_metrics, model_preds]
    operation: evaluate.topk_metric
    arguments:
      target: label
      threshold: 0.5
      graph_loc: /data/groups/bills3/vrenduch/DAGGIT_HOME/daggit_storage/skeleton2/model.png

  - node_name: topk_baserate
    inputs: baseline.baserate
    outputs: [metrics_base, base_preds]
    operation: evaluate.topk_metric
    arguments:
      target: label
      threshold: 0.5
      graph_loc: /data/groups/bills3/vrenduch/DAGGIT_HOME/daggit_storage/skeleton2/base.png

  - node_name: topk_commonsense
    inputs: baseline.commonsense
    outputs: [metrics_commonsense, commonsense_preds]
    operation: evaluate.topk_metric
    arguments:
      target: label
      threshold: 0.5
      graph_loc: /data/groups/bills3/vrenduch/DAGGIT_HOME/daggit_storage/skeleton2/commonsense.png
